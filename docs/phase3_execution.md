## é˜¶æ®µä¸‰æ‰§è¡Œè®¡åˆ’ï¼ˆæŒä¹…åŒ–ä¸å›æ”¾ï¼‰â€”â€”æ‰‹å±€å¼€å§‹å¿«ç…§ + å•ä¼šè¯è¿½åŠ æ—¥å¿— + ç§æœ‰æ—¥å¿—å¯é€‰ + æ˜ç¡®æ¢å¤åè®®ï¼ˆKISS / YAGNIï¼Œå•æ–‡ä»¶ <200 è¡Œï¼‰

æœ¬æ–¹æ¡ˆåœ¨ç°æœ‰é˜¶æ®µä¸€/äºŒçš„â€œå…¨é‡ TABLE_STATE å¹¿æ’­ + äº‹ä»¶æç¤º + ä¼šè¯/ç”Ÿå‘½å‘¨æœŸâ€åŸºç¡€ä¸Šï¼Œå¢é‡å®ç°æŒä¹…åŒ–ä¸å›æ”¾ï¼Œé¿å…é‡æ„åˆ°å®Œæ•´äº‹ä»¶æº¯æºã€‚æ ¸å¿ƒç­–ç•¥ï¼šä»¥â€œæ‰‹å±€å¼€å§‹æ—¶çš„å¿«ç…§â€ä¸ºå”¯ä¸€æ£€æŸ¥ç‚¹ï¼Œä»¥â€œä¼šè¯çº§å•ä¸€è¿½åŠ æ—¥å¿—â€ä¸ºå”¯ä¸€æ•°æ®æºï¼ˆå…¬å…±ï¼‰ï¼Œç§æœ‰æ—¥å¿—å¯é€‰å¼€å¯ä»¥å®ç°100%ä¿çœŸå›æ”¾ã€‚

### 1. ç›®æ ‡ä¸éªŒæ”¶

- ç›®æ ‡
  - æŒä¹…åŒ–ï¼šåœ¨æ¯æ‰‹å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼›åŠ¨ä½œä¸äº‹ä»¶ä»¥ä¼šè¯çº§å•ä¸€ `events.ndjson` è¿½åŠ æ—¥å¿—è®°å½•ï¼ˆå…¬å…±ï¼‰ï¼›å¯é€‰ `private.ndjson` å­˜å‚¨ç§æœ‰å‘ç‰Œäº‹ä»¶ã€‚
  - å›æ”¾ï¼šåŠ è½½å¿«ç…§å¹¶é¡ºåºé‡æ”¾è¯¥æ‰‹çš„äº‹ä»¶æµï¼Œæ¢å¤å…¬å…±çŠ¶æ€ä¸ç»“ç®—ï¼›åœ¨ç®¡ç†å‘˜æ¨¡å¼ä¸‹å¯è¯»å–ç§æœ‰æ—¥å¿—å®ç°é€ç‰Œ100%ä¿çœŸã€‚
  - æ¢å¤ï¼šæœåŠ¡å´©æºƒæˆ–é‡å¯æ—¶ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªå®Œæˆæ‰‹å±€ä¹‹åçš„â€œç­‰å¾…çŠ¶æ€â€ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚
- éªŒæ”¶
  - ç«¯åˆ°ç«¯è·‘é€šï¼šè‹¥å¹²æ‰‹â†’ç»“æŸæ•´å±€â†’è½åœ°ä¼šè¯ç›®å½•â†’å…¬å…±å›æ”¾ä¸€è‡´ï¼›ç®¡ç†å‘˜æ¨¡å¼ä¸‹é€ç‰Œä¸€è‡´ã€‚
  - é‡å¯æ¢å¤ï¼šæ€»èƒ½æ¢å¤åˆ°ä¸Šä¸€ä¸ªå®Œæˆæ‰‹å±€åçš„ `WAITING`ï¼›ä¸ä¼šå¡åœ¨ä¸­é—´æ€ã€‚
  - ä¿æŒâ€œå…¨é‡ TABLE_STATE å¹¿æ’­â€ç­–ç•¥ä¸å˜ï¼›æ–°å¢ä»…ä¸ºæŒä¹…åŒ–/å›æ”¾å†…éƒ¨å®ç°ã€‚

### 2. èŒƒå›´ä¸éç›®æ ‡

- èŒƒå›´
  - æ–‡ä»¶å‹æŒä¹…åŒ–ï¼ˆJSON/NDJSON è‡³ `data/`ï¼‰ï¼›
  - å¿«ç…§/äº‹ä»¶è®°å½•å™¨ä¸æœ€å°å›æ”¾å¼•æ“ï¼›
  - å¯åŠ¨æ—¶æ¢å¤ï¼›æœ€å°åªè¯» Admin ç«¯ç‚¹/CLIã€‚
- éç›®æ ‡ï¼ˆå»¶åï¼‰
  - å®Œæ•´äº‹ä»¶æº¯æºé‡æ„ä¸ç”Ÿäº§æ•°æ®åº“ï¼ˆRedis/Mongoï¼‰ï¼›
  - å®Œæ•´ UI æ’­æ”¾å™¨ï¼ˆæœ¬é˜¶æ®µä»…æ–‡æœ¬æˆ–æœ€å° UI æ”¯æŒï¼‰ã€‚

### 3. æ¶æ„æ€»è§ˆ

- å¿«ç…§ï¼šä»…åœ¨â€œæ‰‹å±€å¼€å§‹åâ€ä¿å­˜ä¼šè¯å¿«ç…§ï¼ˆè¦†ç›–å†™ï¼‰ï¼Œä½œä¸ºæ£€æŸ¥ç‚¹/åŠ é€Ÿå™¨ã€‚
- äº‹ä»¶ï¼šä¼šè¯çº§ `events.ndjson` è¿½åŠ æ‰€æœ‰å…¬å…±åŠ¨ä½œ/äº‹ä»¶ï¼ˆå•ä¸€æ•°æ®æºï¼‰ã€‚
- ç§æœ‰äº‹ä»¶ï¼ˆå¯é€‰ï¼‰ï¼š`private.ndjson` è®°å½• `DECK_SHUFFLED`ã€`HOLE_CARDS_DEALT` ç­‰ï¼Œä»…ç®¡ç†å‘˜å¯è¯»ã€‚
- æ¢å¤ï¼šå¯åŠ¨â†’åŠ è½½æœ€è¿‘å¿«ç…§â†’ä»æ—¥å¿—é‡æ”¾â†’ä¸¢å¼ƒæœªå®Œæˆå°¾éƒ¨â†’è¿›å…¥ `WAITING`ã€‚

### 4. æ•°æ®ä¸æ–‡ä»¶å¸ƒå±€ï¼ˆä¼šè¯çº§å•æ—¥å¿—ï¼‰

- ç›®å½•ç»“æ„
```
data/sessions/{sessionId}/
  â”œâ”€ session.json        # ä¼šè¯å…ƒä¿¡æ¯ + æœ€æ–°å¿«ç…§ï¼ˆè¦†ç›–å†™ï¼‰
  â”œâ”€ events.ndjson       # å…¬å…±äº‹ä»¶/åŠ¨ä½œï¼ŒæŒç»­è¿½åŠ ï¼ˆå•ä¸€æ•°æ®æºï¼‰
  â”œâ”€ private.ndjson      # å¯é€‰ï¼šç§æœ‰äº‹ä»¶ï¼ˆå®Œæ•´å‘ç‰Œå‰§æœ¬ï¼‰ï¼Œé»˜è®¤å…³é—­
  â””â”€ events.idx          # å¯é€‰ï¼šç´¢å¼•ï¼ˆhandNumber â†’ æ–‡ä»¶åç§»ï¼‰æå‡å›æ”¾/æ¢å¤é€Ÿåº¦
```
- `session.json`ï¼ˆå¿«ç…§ï¼‰
```json
{
  "meta": { "version": 1, "savedAt": 1730000000000 },
  "session": { "id": "session_xxx", "startedAt": 1729990000000, "handsPlayed": 13 },
  "gameState": { /* GameStateSerializer.serialize() è¾“å‡ºï¼ˆè§ Â§6ï¼‰ */ }
}
```
- `events.ndjson`ï¼ˆæ¯è¡Œä¸€äº‹ä»¶ï¼‰
```json
{"seq":1,"t":1730000000100,"sessionId":"session_xxx","handNumber":14,"type":"HAND_STARTED","payload":{}}
{"seq":2,"t":1730000000200,"sessionId":"session_xxx","handNumber":14,"type":"PLAYER_ACTION","payload":{"playerId":"p1","action":"bet","amount":100}}
{"seq":3,"t":1730000000300,"sessionId":"session_xxx","handNumber":14,"type":"FLOP_DEALT","payload":{"cards":["Ah","Kd","7s"]}}
{"seq":9,"t":1730000000900,"sessionId":"session_xxx","handNumber":14,"type":"HAND_FINISHED","payload":{"pots":[...],"winners":["p1"]}}
```
- `private.ndjson`ï¼ˆå¯é€‰ï¼‰
```json
{"seq":1,"t":1730000000050,"type":"DECK_SHUFFLED","payload":{"orderedDeck":["As","Kh","..."]}}
{"seq":2,"t":1730000000150,"type":"HOLE_CARDS_DEALT","payload":{"playerId":"p1","cards":["Ah","Kd"]}}
```

### 5. äº‹ä»¶æ¨¡å‹ï¼ˆæœ€å°å¿…è¦é›†ï¼‰

- åŠ¨ä½œç±»ï¼š`PLAYER_ACTION { playerId, action, amount? }`
- æµç¨‹ç±»ï¼š`HAND_STARTED`ã€`ROUND_CLOSED`ã€`STREET_ADVANCED`ã€`FLOP_DEALT`ã€`TURN_DEALT`ã€`RIVER_DEALT`ã€`SHOWDOWN_STARTED`ã€`POTS_DISTRIBUTED`ã€`HAND_FINISHED`ã€`GAME_ENDED`
- å­—æ®µè§„èŒƒ
  - å…¬å…±äº‹ä»¶æ ¼å¼ï¼š`{ seq, t, sessionId, handNumber, type, payload }`
  - ç§æœ‰äº‹ä»¶æ ¼å¼ï¼š`{ seq, t, type, payload }`ï¼ˆä¸æš´éœ² sessionId/handNumber ç»™å…¬å…± APIï¼‰

### 6. å¿«ç…§ç­–ç•¥ï¼ˆå•ä¸€æ£€æŸ¥ç‚¹ï¼‰

- æ—¶æœºï¼šä»…åœ¨â€œæ‰‹å±€å¼€å§‹åâ€ï¼ˆ`HAND_STARTED` å†™å…¥ events åï¼‰ä¿å­˜ä¼šè¯å¿«ç…§ã€‚
- å†…å®¹ï¼š`meta` + `session` æ‘˜è¦ + `gameState`ã€‚
- GameState åºåˆ—åŒ–è¦æ±‚ï¼ˆè¡¥é½/å‰”é™¤ï¼‰ï¼š
  - åŒ…å«ï¼š`gameId, street, phase, tableStatus, players[*]{id,name,chips,position,status,currentBet,totalBet,isDealer,isSmallBlind,isBigBlind,hasCards}, communityCards, pots, totalPot, currentTurn, amountToCall, buttonIndex, handNumber, isActionReopened, activePlayersCount, lastAggressorId, actionHistory, lastShowdownSummary, session{id,startedAt,handsPlayed}`
  - å‰”é™¤ï¼š`players[*].holeCards`ï¼ˆæœªæ­ç¤ºåº•ç‰Œï¼‰ï¼›ä»»ä½•ä¸´æ—¶å¯¹è±¡å¼•ç”¨ã€‚
- ä¸å†åœ¨å¿«ç…§ä¸­å­˜å‚¨ `lastHandResult`ï¼›ç»“æœä»äº‹ä»¶æµæ¨å¯¼ï¼Œä¿è¯â€œå•ä¸€æ•°æ®æºâ€ã€‚

### 7. æ¢å¤åè®®ï¼ˆç¡®å®šæ€§ï¼‰

- å¯åŠ¨æ—¶ï¼š
  - å®šä½æœ€è¿‘ä¼šè¯ç›®å½• `data/sessions/{sessionId}/`
  - è¯»å– `session.json` â†’ åŠ è½½å¿«ç…§ï¼ˆæ‰‹å±€å¼€å§‹æ€ï¼‰
  - ä» `events.ndjson` æµå¼è¯»å–â€œè‡ªè¯¥æ‰‹å¼€å§‹è‡³æœ€è¿‘ `HAND_FINISHED`â€çš„äº‹ä»¶å¹¶é‡æ”¾
  - å¿½ç•¥/ä¸¢å¼ƒ `HAND_FINISHED` ä¹‹åæœªé—­åˆçš„å°¾æ®µï¼ˆè§†ä¸ºå´©æºƒä¸­æ–­ï¼‰
  - è¿›å…¥ `WAITING`ï¼Œå‡†å¤‡å¼€å§‹ä¸‹ä¸€æ‰‹
- å¯é€‰ä¼˜åŒ–ï¼šä½¿ç”¨ `events.idx` å¿«é€Ÿå®šä½æ‰‹å·åŒºé—´åç§»

### 8. ç»„ä»¶ä¸ä¾èµ–å…³ç³»

- `src/server/persistence/storage/Storage.js`
  - å®šä¹‰å­˜å‚¨æ¥å£ï¼ˆappend/save/read/listï¼‰ï¼Œé›¶å®ç°ä¾èµ–
- `src/server/persistence/storage/FileStorage.js`
  - Node `fs/promises` å®ç°ï¼›`appendEvent` ä½¿ç”¨ O_APPENDï¼›è¦†ç›–å†™å¿«ç…§é‡‡ç”¨â€œä¸´æ—¶æ–‡ä»¶+renameâ€
- `src/server/persistence/EventLogger.js`
  - ä¾èµ– `Storage`ï¼›æä¾› `appendPublicEvent()`ã€å¯é€‰ `rotateIndex()`ï¼›ç”± `server` è°ƒç”¨
- `src/server/persistence/PrivateEventLogger.js`ï¼ˆå¯é€‰ï¼‰
  - ä¾èµ– `Storage`ï¼›åœ¨å¯ç”¨æ—¶è®°å½• `DECK_SHUFFLED`ã€`HOLE_CARDS_DEALT`
- `src/server/persistence/SnapshotManager.js`
  - ä¾èµ– `Storage`ã€`Game` åªè¯» getterï¼›åœ¨ `HAND_STARTED` åä¿å­˜å¿«ç…§
- `src/game/replay/ScriptedDeck.js`
  - å—æ§ç‰Œå †ï¼Œä»…å›æ”¾ç”¨ï¼›å…¬å…±æ¨¡å¼å¯ä¸ä¸¥æ ¼ä½¿ç”¨
- `src/game/replay/ReplayEngine.js`
  - ä¾èµ– `Game`ã€`ScriptedDeck`ã€`Storage`ï¼ˆæˆ–æ–‡ä»¶ï¼‰ï¼›æ”¯æŒå…¬å…±/ç®¡ç†å‘˜ä¸¤ç§å›æ”¾æ¨¡å¼

ä¾èµ–å›¾ï¼ˆæ‘˜è¦ï¼‰ï¼š
- `server/server.js` â†’ { `EventLogger`, `SnapshotManager` } â†’ `Storage`
- `ReplayEngine` â†’ { `Storage` | æ–‡ä»¶ } + `Game` + `ScriptedDeck`

### 9. æœåŠ¡ç«¯é›†æˆç‚¹ï¼ˆæœ€å°ä¾µå…¥ï¼‰

- `handlePlayerAction(payload)`ï¼š
  - å…ˆ `EventLogger.appendPublicEvent({type:'PLAYER_ACTION', ...})`
  - è°ƒç”¨ `game.applyAction()`ï¼›éšåç”± `handleGameEvents()` è®°å½•äº§ç”Ÿçš„æµç¨‹äº‹ä»¶
- `handleGameEvents(events)`ï¼š
  - é€æ¡ `EventLogger.appendPublicEvent(event)`
  - ç¢°åˆ° `HAND_STARTED` åâ†’è§¦å‘ `SnapshotManager.saveSnapshot()`
  - `HAND_FINISHED` ä»…è½äº‹ä»¶ï¼Œä¸ä¿å­˜å¿«ç…§
- `server.startGame()` æˆåŠŸåï¼š
  - ç”Ÿæˆå¹¶å¹¿æ’­/è®°å½• `HAND_STARTED`ï¼ˆä¿æŒ `Game` æ— ä¾µå…¥ï¼‰
- `GAME_ENDED`ï¼šè½äº‹ä»¶ï¼›`session.json` å¯æ›´æ–° `handsPlayed` ä¸å…ƒä¿¡æ¯

### 10. å›æ”¾å¼•æ“ï¼ˆä¸¤ç§ç²¾åº¦ï¼‰

- å…¬å…±æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š`session.json` + `events.ndjson`ï¼Œç”¨ `ScriptedDeck` æˆ–å…¬å…±äº‹ä»¶é©±åŠ¨ï¼›æœªæ­ç¤ºåº•ç‰Œä¿æŒä¸å¯è§ï¼›å¯¹é½å…¬å…±ç»“è®ºï¼ˆpotsã€èµ¢å®¶ã€`lastShowdownSummary`ï¼‰
- ç®¡ç†å‘˜æ¨¡å¼ï¼ˆå¯é€‰ï¼‰ï¼šé¢å¤–è¯»å– `private.ndjson`ï¼ˆé”å®šè®¿é—®ï¼‰ï¼Œä»¥ `DECK_SHUFFLED`/`HOLE_CARDS_DEALT` 100%å¤åŸé€ç‰Œé¡ºåº

### 11. å®‰å…¨ä¸éšç§

- ç§æœ‰æ—¥å¿—é»˜è®¤å…³é—­ï¼š`PERSIST_PRIVATE=false`
- ä»»ä½•å…¬å…± API ä¸æš´éœ² `private.ndjson`
- ç®¡ç†è¯»å–ä»…åœ¨æœ¬åœ°æˆ–å—æ§å·¥å…·ï¼›å¯é€‰åŠ å¯†/ç­¾åï¼ˆå»¶åï¼‰

### 12. æµ‹è¯•è®¡åˆ’

- å•å…ƒæµ‹è¯•
  - `FileStorage`ï¼šappend/è¦†ç›–å†™/å¹¶å‘å®‰å…¨ï¼›å¼‚å¸¸å›æ»š
  - `SnapshotManager`ï¼š`HAND_STARTED` è§¦å‘ã€å¿«ç…§ç»“æ„ä¸å‰”é™¤ç­–ç•¥æ­£ç¡®
  - `EventLogger`ï¼šåºå·/æ—¶é—´æˆ³/è¿‡æ»¤ handNumber æ­£ç¡®ï¼›ï¼ˆå¯é€‰ï¼‰ç´¢å¼•ç”Ÿæˆæ­£ç¡®
  - `ReplayEngine`ï¼šå…¬å…±æ¨¡å¼ç»“è®ºä¸€è‡´ï¼›ç®¡ç†å‘˜æ¨¡å¼ç‰Œé¢/é¡ºåºå®Œå…¨ä¸€è‡´
  - `GameStateSerializer`ï¼šé˜¶æ®µäºŒå­—æ®µåºåˆ—åŒ–/ååºåˆ—åŒ–ç¨³å®šï¼Œä¸æ³„éœ²ç§æœ‰ç‰Œ
- é›†æˆæµ‹è¯•
  - æ‰“å¤šæ‰‹â†’ç»“æŸâ†’æ£€æŸ¥ `data/sessions/{sid}` æ–‡ä»¶ä¸æ ¸å¿ƒå­—æ®µ
  - æœåŠ¡é‡å¯â†’æŒ‰æ¢å¤åè®®è¿›å…¥ `WAITING`ï¼›æ‰‹æ•°/ç»“ç®—ä¸€è‡´
  - å›æ”¾æ•´ä¼šè¯â†’é€æ‰‹æ ¡éªŒ pots/èµ¢å®¶/`lastShowdownSummary` ä¸€è‡´

### 13. ä»»åŠ¡æ‹†åˆ†ä¸æ’æœŸï¼ˆ3â€“5 äººæ—¥ï¼‰

1) å­˜å‚¨ä¸å¸ƒå±€ï¼ˆ0.5â€“0.8dï¼‰ï¼š`Storage`/`FileStorage`ï¼ˆappend+è¦†ç›–ã€ç›®å½•ç»“æ„ï¼‰
2) äº‹ä»¶ä¸å¿«ç…§æ¥å…¥ï¼ˆ1â€“1.2dï¼‰ï¼š`EventLogger`ã€`SnapshotManager`ï¼›`HAND_STARTED` æ—¶æœºæŒ‚é’©
3) ç§æœ‰æ—¥å¿—ï¼ˆå¯é€‰ï¼Œ0.4â€“0.6dï¼‰ï¼š`PrivateEventLogger`ã€é…ç½®å¼€å…³
4) å›æ”¾å¼•æ“ï¼ˆ0.8â€“1.2dï¼‰ï¼šå…¬å…±æ¨¡å¼å¿…åšï¼›ç®¡ç†å‘˜æ¨¡å¼æ”¯æŒç§æœ‰æ—¥å¿—
5) æ¢å¤åè®®ä¸ç«¯ç‚¹ï¼ˆ0.3â€“0.5dï¼‰ï¼šå¯åŠ¨æ¢å¤ï¼›åªè¯» admin ç«¯ç‚¹
6) æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ0.6â€“1dï¼‰ï¼šå®Œå–„æµ‹è¯•çŸ©é˜µï¼›æ›´æ–° `README`/`docs`

### 14. é£é™©ä¸ç¼“è§£

- å›æ”¾ä¸ä¸€è‡´ï¼ˆå…¬å…±ä¿¡æ¯ä¸è¶³ï¼‰ï¼šç®¡ç†å‘˜æ¨¡å¼å¯ç”¨ç§æœ‰æ—¥å¿—è·å¾— 100% ä¿çœŸ
- æ–‡ä»¶å¢é•¿ï¼šæŒ‰ä¼šè¯æ»šåŠ¨ï¼›å¯å¢é‡å‹ç¼©å½’æ¡£ï¼ˆå»¶åï¼‰ï¼›å¯é€‰äº‹ä»¶ç´¢å¼•
- å¯åŠ¨æ¢å¤æ€§èƒ½ï¼šå…ˆçº¿æ€§æ‰«æï¼Œå¿…è¦æ—¶å¯ç”¨ `events.idx`
- ä¾µå…¥é£é™©ï¼šæ‰€æœ‰æ¥å…¥ç‚¹é›†ä¸­åœ¨ `server.js` åŠ¨ä½œå…¥å£/äº‹ä»¶å›è°ƒ/æ‰‹å±€å¼€å§‹æ—¶æœºï¼Œ`Game` å†…æ ¸é›¶æ”¹åŠ¨

### 15. æ¥å£ä¸ç«¯ç‚¹è‰æ¡ˆ

- Storage æŠ½è±¡
```ts
interface Storage {
  saveSnapshot(sessionId: string, data: object): Promise<void>; // è¦†ç›–å†™ session.json
  appendPublicEvent(sessionId: string, evt: object): Promise<void>; // è¿½åŠ  events.ndjson
  appendPrivateEvent?(sessionId: string, evt: object): Promise<void>; // å¯é€‰
  listSessions(): Promise<Array<{sessionId:string, startedAt:number, hands:number}>>;
  readSession(sessionId: string): Promise<object>;
  streamPublicEvents(sessionId: string, fromSeq?: number): AsyncIterable<object>;
}
```
- Adminï¼ˆåªè¯»ï¼‰
  - `GET /admin/sessions`ï¼šåˆ—å‡ºç°æœ‰ä¼šè¯ï¼ˆä¸å«ç§æœ‰ï¼‰
  - `GET /admin/sessions/:id/meta`ï¼šè¿”å› `session.json`
  - `GET /admin/sessions/:id/events?fromSeq=`ï¼šæµå¼è¿”å›å…¬å…±äº‹ä»¶
  - å¯é€‰ï¼š`POST /admin/reload/latest`ï¼šå¼€å‘ç¯å¢ƒä»æœ€è¿‘ä¼šè¯æ¢å¤

### 16. é…ç½®å¼€å…³ï¼ˆç¯å¢ƒå˜é‡ï¼‰

- `PERSIST_ENABLED=true`
- `PERSIST_PRIVATE=false`ï¼ˆé»˜è®¤ï¼‰
- `DATA_DIR=./data/sessions`
- `EVENT_INDEX_ENABLED=false`ï¼ˆé»˜è®¤ï¼‰

### 17. 200 è¡Œçº¦æŸä¸ä¸€è‡´æ€§å£°æ˜

- æ–°å¢æ¯ä¸ªæºæ–‡ä»¶ä¸¥æ ¼ <200 è¡Œï¼›å¿…è¦æ—¶ç»§ç»­æ‹†åˆ†å­æ¨¡å—ã€‚
- ä¸æ”¹å˜é˜¶æ®µä¸€/äºŒå¤–éƒ¨è¡Œä¸ºä¸æ¶ˆæ¯ç»“æ„ï¼›ä»…æ–°å¢æŒä¹…åŒ–/å›æ”¾å†…éƒ¨èƒ½åŠ›ã€‚
- ä¿æŒâ€œå…¨é‡ TABLE_STATE å¹¿æ’­ + ç§æœ‰å•æ’­ä¸æ³„éœ²â€ç­–ç•¥ï¼›å…¬å…±å¿«ç…§ä¸å«æœªæ­ç¤ºåº•ç‰Œã€‚

---

- å˜æ›´è¦ç‚¹å›é¡¾
  - å¿«ç…§ä»…åœ¨â€œæ‰‹å±€å¼€å§‹â€ä¿å­˜ï¼›ä»äº‹ä»¶æ¨å¯¼ç»“æœï¼Œç¡®ç«‹å•ä¸€æ•°æ®æºã€‚
  - ä¼šè¯çº§å•ä¸€è¿½åŠ æ—¥å¿—ï¼ˆå…¬å…±ï¼‰ï¼›ç§æœ‰æ—¥å¿—å¯é€‰å¼€å¯å®ç° 100% ä¿çœŸã€‚
  - æ˜ç¡®æ¢å¤åè®®ï¼šåŠ è½½å¿«ç…§â†’é‡æ”¾è‡³æœ€è¿‘ `HAND_FINISHED`â†’ä¸¢å¼ƒå°¾éƒ¨â†’è¿›å…¥ `WAITING`ã€‚
  - æœ€å°ä¾µå…¥æ¥å…¥ `server.js`ï¼›`Game` å†…æ ¸ä¸å˜ï¼›æµ‹è¯•ä¸ç«¯ç‚¹è¦†ç›–ä¸€è‡´æ€§ã€‚

### 18. Gitå·¥ä½œæµä¸æäº¤ç­–ç•¥

#### 18.1 åˆ†æ”¯ç®¡ç†ç­–ç•¥

- **åŠŸèƒ½åˆ†æ”¯å‘½åè§„èŒƒ**ï¼š
  - `phase3-storage-foundation` - å­˜å‚¨åŸºç¡€å±‚ âœ…å·²å®Œæˆ
  - `phase3-event-logging` - äº‹ä»¶è®°å½•å™¨
  - `phase3-snapshot-manager` - å¿«ç…§ç®¡ç†å™¨  
  - `phase3-replay-engine` - å›æ”¾å¼•æ“
  - `phase3-server-integration` - æœåŠ¡ç«¯é›†æˆ
  - `phase3-complete` - æœ€ç»ˆé›†æˆåˆ†æ”¯

- **åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸ**ï¼š
  1. ä»æœ€æ–°masteråˆ›å»ºåŠŸèƒ½åˆ†æ”¯
  2. å®ŒæˆåŠŸèƒ½å¼€å‘å’Œæµ‹è¯•
  3. æäº¤åˆ°åŠŸèƒ½åˆ†æ”¯å¹¶æ¨é€
  4. åˆå¹¶åˆ°masterï¼ˆé€šè¿‡PRæˆ–ç›´æ¥mergeï¼‰
  5. åˆ é™¤åŠŸèƒ½åˆ†æ”¯

#### 18.2 Commitæ—¶æœºä¸è§„èŒƒ

##### é˜¶æ®µæ€§CommitæŒ‡å¯¼
æ¯ä¸ªå¼€å‘æ­¥éª¤åº”å½“åœ¨ä»¥ä¸‹æ—¶æœºè¿›è¡Œcommitï¼š

1. **å­˜å‚¨åŸºç¡€å±‚** âœ…å·²å®Œæˆ (commit: c27dd16)
   ```bash
   # å•ä¸ªåŠŸèƒ½å®Œæˆåç«‹å³commit
   git add .
   git commit -m "é˜¶æ®µä¸‰ç¬¬ä¸€æ­¥ï¼šå®ç°å­˜å‚¨æŠ½è±¡å±‚å’Œæ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–"
   ```

2. **äº‹ä»¶è®°å½•å™¨å¼€å‘**
   ```bash
   # EventLoggerå®ç°å®Œæˆå
   git add src/server/persistence/EventLogger.js
   git commit -m "å®ç°EventLogger - å…¬å…±äº‹ä»¶è®°å½•å™¨"
   
   # PrivateEventLoggerå®ç°å®Œæˆå  
   git add src/server/persistence/PrivateEventLogger.js
   git commit -m "å®ç°PrivateEventLogger - ç§æœ‰äº‹ä»¶è®°å½•å™¨"
   
   # åŠŸèƒ½æµ‹è¯•å®Œæˆå
   git add test/
   git commit -m "æ·»åŠ EventLoggeråŠŸèƒ½æµ‹è¯•å’Œæ–‡æ¡£"
   ```

3. **å¿«ç…§ç®¡ç†å™¨å¼€å‘**
   ```bash
   # SnapshotManagerå®ç°å®Œæˆå
   git add src/server/persistence/SnapshotManager.js
   git commit -m "å®ç°SnapshotManager - æ‰‹å±€å¼€å§‹å¿«ç…§ç®¡ç†"
   
   # é›†æˆæµ‹è¯•é€šè¿‡å
   git commit -m "SnapshotManageré›†æˆæµ‹è¯•é€šè¿‡"
   ```

4. **å›æ”¾å¼•æ“å¼€å‘**
   ```bash
   # ScriptedDeckå®ç°å®Œæˆå
   git add src/game/replay/ScriptedDeck.js
   git commit -m "å®ç°ScriptedDeck - å¯æ§å‘ç‰Œå›æ”¾"
   
   # ReplayEngineå®ç°å®Œæˆå
   git add src/game/replay/ReplayEngine.js
   git commit -m "å®ç°ReplayEngine - åŒæ¨¡å¼å›æ”¾å¼•æ“"
   
   # ç«¯åˆ°ç«¯å›æ”¾æµ‹è¯•é€šè¿‡å
   git commit -m "å›æ”¾å¼•æ“ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡"
   ```

5. **æœåŠ¡ç«¯é›†æˆ**
   ```bash
   # server.jsæœ€å°ä¾µå…¥é›†æˆå
   git add src/server/server.js
   git commit -m "server.jsé›†æˆæŒä¹…åŒ–é’©å­"
   
   # æ¢å¤åè®®å®ç°å
   git commit -m "å®ç°å¯åŠ¨æ—¶çŠ¶æ€æ¢å¤åè®®"
   
   # å®Œæ•´é›†æˆæµ‹è¯•å
   git commit -m "æŒä¹…åŒ–ç³»ç»ŸæœåŠ¡ç«¯é›†æˆå®Œæˆ"
   ```

##### Commitæ¶ˆæ¯è§„èŒƒ
```bash
# æ ¼å¼ï¼š<ç±»å‹>: <ç®€çŸ­æè¿°>
#
# è¯¦ç»†è¯´æ˜ï¼š
# - åŠŸèƒ½ç‰¹ç‚¹
# - æŠ€æœ¯å®ç°è¦ç‚¹  
# - éªŒæ”¶æ ‡å‡†
#
# ğŸ¤– Generated with Claude Code
# Co-Authored-By: Claude <noreply@anthropic.com>

# ç¤ºä¾‹ï¼š
git commit -m "feat: å®ç°EventLogger - å…¬å…±äº‹ä»¶è®°å½•å™¨

âœ… å®ŒæˆåŠŸèƒ½ï¼š
- æ”¯æŒä¼šè¯çº§äº‹ä»¶è¿½åŠ è®°å½•
- è‡ªåŠ¨åºå·ç”Ÿæˆå’Œæ—¶é—´æˆ³
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

ğŸ“ ä»£ç è´¨é‡ï¼š
- ä¸¥æ ¼éµå¾ª<200è¡Œé™åˆ¶ (156è¡Œ)
- å®Œæ•´å•å…ƒæµ‹è¯•è¦†ç›–
- è¯¦ç»†æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

ğŸ¤– Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>"
```

#### 18.3 Pushç­–ç•¥

##### åŠŸèƒ½åˆ†æ”¯Pushæ—¶æœº
- **å³æ—¶æ¨é€**ï¼šæ¯æ¬¡commitåç«‹å³pushåˆ°åŠŸèƒ½åˆ†æ”¯
  ```bash
  git push origin phase3-event-logging
  ```

- **ä¿æŠ¤åŸåˆ™**ï¼šç»ä¸ç›´æ¥pushåˆ°masterï¼Œå§‹ç»ˆé€šè¿‡åŠŸèƒ½åˆ†æ”¯
  ```bash
  # âŒ ç¦æ­¢
  git push origin master
  
  # âœ… æ­£ç¡®
  git push origin phase3-feature-name
  ```

##### Masteråˆå¹¶æ¡ä»¶
åªæœ‰æ»¡è¶³ä»¥ä¸‹**æ‰€æœ‰æ¡ä»¶**æ—¶ï¼Œæ‰èƒ½åˆå¹¶åˆ°masterï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - [ ] æ‰€æœ‰è®¡åˆ’åŠŸèƒ½å·²å®ç°
   - [ ] å•å…ƒæµ‹è¯•100%é€šè¿‡
   - [ ] é›†æˆæµ‹è¯•éªŒè¯é€šè¿‡
   - [ ] æ–‡æ¡£å®Œæ•´ä¸”å‡†ç¡®

2. **ä»£ç è´¨é‡**
   - [ ] æ‰€æœ‰æ–‡ä»¶ä¸¥æ ¼éµå¾ª<200è¡Œé™åˆ¶
   - [ ] ä»£ç é£æ ¼ä¸€è‡´ï¼Œéµå¾ªKISS/YAGNIåŸåˆ™
   - [ ] æ— æ˜æ˜¾çš„ä»£ç å¼‚å‘³æˆ–æŠ€æœ¯å€ºåŠ¡
   - [ ] é”™è¯¯å¤„ç†å®Œå–„

3. **å‘åå…¼å®¹**
   - [ ] ä¸ç ´åç°æœ‰é˜¶æ®µ1.0/1.5åŠŸèƒ½
   - [ ] ç°æœ‰APIæ¥å£ä¿æŒä¸å˜
   - [ ] ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡
   - [ ] å®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹

4. **éªŒæ”¶æµ‹è¯•**
   - [ ] ç«¯åˆ°ç«¯æ¸¸æˆæµç¨‹æ­£å¸¸
   - [ ] æŒä¹…åŒ–åŠŸèƒ½å·¥ä½œæ­£å¸¸
   - [ ] æ¢å¤åè®®éªŒè¯é€šè¿‡
   - [ ] æ€§èƒ½æ— æ˜æ˜¾é€€åŒ–

##### æœ€ç»ˆPushåˆ°Master
```bash
# ç¡®ä¿åŠŸèƒ½åˆ†æ”¯æœ€æ–°
git checkout phase3-complete
git pull origin phase3-complete

# åˆ‡æ¢åˆ°masterå¹¶åˆå¹¶
git checkout master  
git pull origin master
git merge phase3-complete

# æœ€ç»ˆéªŒè¯åæ¨é€
npm test                    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm start                   # ç¡®ä¿æœåŠ¡æ­£å¸¸å¯åŠ¨
git push origin master

# æ¸…ç†åŠŸèƒ½åˆ†æ”¯
git branch -d phase3-complete
git push origin --delete phase3-complete
```

#### 18.4 é˜¶æ®µæ€§é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | åˆ†æ”¯ | éªŒæ”¶æ ‡å‡† | é¢„è®¡æ—¶é—´ |
|--------|------|----------|----------|
| å­˜å‚¨åŸºç¡€ | phase3-storage-foundation | Storageæ¥å£+FileStorageå®ç°+æµ‹è¯• | âœ… å·²å®Œæˆ |
| äº‹ä»¶è®°å½• | phase3-event-logging | EventLogger+PrivateEventLogger+é›†æˆ | 1å¤© |
| å¿«ç…§ç®¡ç† | phase3-snapshot-manager | SnapshotManager+æ—¶æœºæ§åˆ¶+æµ‹è¯• | 0.8å¤© |
| å›æ”¾å¼•æ“ | phase3-replay-engine | ReplayEngine+ScriptedDeck+åŒæ¨¡å¼ | 1.2å¤© |
| æœåŠ¡é›†æˆ | phase3-server-integration | server.jsé›†æˆ+æ¢å¤åè®®+ç«¯åˆ°ç«¯ | 1å¤© |
| æœ€ç»ˆéªŒæ”¶ | phase3-complete | å®Œæ•´åŠŸèƒ½+æ–‡æ¡£+æµ‹è¯•+æ€§èƒ½éªŒè¯ | 0.5å¤© |

#### 18.5 é£é™©æ§åˆ¶

##### å›æ»šç­–ç•¥
```bash
# å¦‚æœåŠŸèƒ½åˆ†æ”¯å‡ºç°é—®é¢˜ï¼Œç«‹å³å›æ»šåˆ°å®‰å…¨ç‚¹
git reset --hard <last-good-commit>
git push --force origin feature-branch

# å¦‚æœmasterå‡ºç°é—®é¢˜ï¼Œåˆ›å»ºhotfixåˆ†æ”¯ä¿®å¤
git checkout master
git checkout -b hotfix-phase3-critical
# ä¿®å¤é—®é¢˜ååˆå¹¶å›master
```

##### å¤‡ä»½ç­–ç•¥
- é‡è¦é‡Œç¨‹ç¢‘ååˆ›å»ºæ ‡ç­¾ï¼š
  ```bash
  git tag v1.5.1-phase3-storage-foundation
  git push origin v1.5.1-phase3-storage-foundation
  ```

- å®šæœŸå¤‡ä»½åŠŸèƒ½åˆ†æ”¯ï¼š
  ```bash
  git checkout phase3-current-work
  git checkout -b backup/phase3-$(date +%Y%m%d)
  git push origin backup/phase3-$(date +%Y%m%d)
  ```

#### 18.6 åä½œè§„èŒƒ

- **ä»£ç å®¡æŸ¥**ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼š
  - æ¯ä¸ªåŠŸèƒ½å®Œæˆåè¿›è¡Œè‡ªæˆ‘å®¡æŸ¥
  - å…³é”®åŠŸèƒ½è¯·å…¶ä»–å¼€å‘è€…å®¡æŸ¥
  - é‡ç‚¹æ£€æŸ¥ï¼šåŠŸèƒ½æ­£ç¡®æ€§ã€ä»£ç è´¨é‡ã€æµ‹è¯•è¦†ç›–

- **æ–‡æ¡£åŒæ­¥**ï¼š
  - ä»£ç æ›´æ”¹å¿…é¡»åŒæ­¥æ›´æ–°ç›¸å…³CLAUDE.md
  - æ–°åŠŸèƒ½å¿…é¡»åŒ…å«ä½¿ç”¨ç¤ºä¾‹
  - APIå˜æ›´å¿…é¡»æ›´æ–°æ¥å£æ–‡æ¡£

- **æµ‹è¯•ä¼˜å…ˆ**ï¼š
  - åŠŸèƒ½å®ç°å‰å…ˆå†™æµ‹è¯•ç”¨ä¾‹
  - æ¯æ¬¡commitå‰è¿è¡Œç›¸å…³æµ‹è¯•
  - æ–°åŠŸèƒ½å¿…é¡»åŒ…å«å®Œæ•´æµ‹è¯•è¦†ç›–

é€šè¿‡è¿™å¥—å®Œæ•´çš„Gitå·¥ä½œæµç­–ç•¥ï¼Œç¡®ä¿é˜¶æ®µä¸‰å¼€å‘è¿‡ç¨‹çš„å¯æ§æ€§ã€å¯è¿½æº¯æ€§å’Œé«˜è´¨é‡äº¤ä»˜ã€‚