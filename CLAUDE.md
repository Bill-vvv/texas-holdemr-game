# 德州扑克项目 - 主文档

## 项目概述
这是一个完整的在线德州扑克游戏系统，使用Node.js后端和原生JavaScript前端构建，支持多人实时游戏。

## 技术栈
- **后端**: Node.js + Express + Socket.IO
- **前端**: 原生JavaScript + HTML5 + CSS3
- **通信**: WebSocket实时双向通信
- **架构**: 聚合根模式 + 事件驱动

## 开发阶段

### 阶段1.0 (已完成)
- ✅ 基础游戏框架搭建
- ✅ 完整的德州扑克游戏逻辑
- ✅ 多人实时对战功能
- ✅ WebSocket通信系统
- ✅ 响应式UI界面

### 阶段1.5 (已完成) 
- ✅ **Feature A**: 摊牌结果详细展示
  - 获胜者牌型显示（"同花顺"、"三条"等）
  - 最佳五张牌组合
  - 使用底牌标识
  - 自动摊牌摘要生成
- ✅ **Feature B**: 房主手动结束整局
  - 房主权限控制
  - 整局结算统计
  - 玩家盈亏分析
  - 会话时长和手数统计

## 项目结构

```
D:\project3\
├── src/
│   ├── game/                    # 游戏核心逻辑
│   │   ├── actions/            # 动作处理（ActionValidator、ActionApplier）
│   │   ├── core/               # 核心组件（Deck、HandEvaluator）
│   │   ├── pot/                # 彩池管理（PotManager）
│   │   ├── rules/              # 规则配置（TableRules）
│   │   ├── Game.js             # 游戏聚合根
│   │   ├── GameState.js        # 状态管理
│   │   ├── TurnManager.js      # 回合管理
│   │   ├── BlindsManager.js    # 盲注管理
│   │   └── CLAUDE.md           # 游戏模块文档
│   ├── server/                 # 服务端模块
│   │   ├── server.js           # 主服务器
│   │   ├── playerRegistry.js   # 玩家注册管理
│   │   ├── protocol.js         # 通信协议
│   │   └── CLAUDE.md           # 服务端模块文档
│   └── ui/                     # 前端界面
│       ├── public/
│       │   ├── index.html      # 主界面
│       │   └── client.js       # 客户端逻辑
│       └── CLAUDE.md           # UI模块文档
├── package.json                # 项目配置
└── CLAUDE.md                   # 项目主文档（本文件）
```

## 模块索引

### 核心游戏模块
- **[@src/game/CLAUDE.md](./src/game/CLAUDE.md)** - 游戏核心逻辑模块
  - Game.js - 游戏聚合根，协调所有模块
  - GameState.js - 状态管理，包含阶段1.5的摊牌和会话功能
  - 动作处理、彩池管理、规则配置等子模块

### 服务端模块  
- **[@src/server/CLAUDE.md](./src/server/CLAUDE.md)** - 服务端通信和协调
  - server.js - 主服务器，包含阶段1.5的房主结束整局功能
  - playerRegistry.js - 玩家连接管理
  - protocol.js - 通信协议，包含新增的消息类型

### 前端界面模块
- **[@src/ui/CLAUDE.md](./src/ui/CLAUDE.md)** - 用户界面和交互
  - index.html - 响应式游戏界面，包含新增的摊牌和结算显示区域
  - client.js - 客户端逻辑，包含阶段1.5的新增功能

## 阶段1.5功能详解

### Feature A: 摊牌结果展示
当游戏进入摊牌阶段时，系统自动展示获胜者的详细信息：

**技术实现**:
- HandEvaluator.describeBestHand() - 新增方法分析牌型详情
- Game._generateShowdownSummary() - 在摊牌时自动生成摘要
- GameState.lastShowdownSummary - 存储摊牌结果
- UI自动显示获胜牌型、最佳五张牌和使用的底牌

**用户体验**:
- 🏆 清晰的获胜者标识
- 🃏 直观的牌型展示（"同花顺"、"三条"等中文名称）
- 🎯 最佳五张牌组合显示
- 📋 底牌使用情况标识

### Feature B: 房主手动结束整局
房主可以在任何时候手动结束整局并查看完整统计：

**技术实现**:
- 会话管理系统跟踪玩家初始买入和当前筹码
- Game.endSession() - 计算整局盈亏统计
- 服务端权限验证确保只有房主可以操作
- 实时广播结束消息给所有玩家

**功能特性**:
- 📊 完整的盈亏统计（基于初始买入金额）
- ⏱️ 会话时长和总手数统计
- 💰 彩色盈亏显示（绿色盈利、红色亏损）
- 🔐 严格的房主权限控制

## 游戏特性

### 完整德州扑克规则
- 支持2-9人游戏
- 标准德州扑克流程（翻牌前→翻牌→转牌→河牌→摊牌）
- 精确的盲注和按钮位管理
- 复杂边池分配算法
- All-in和筹码不足处理

### 实时多人对战
- WebSocket双向通信
- 游戏状态实时同步
- 玩家动作即时响应
- 连接状态监控

### 用户友好界面
- 响应式设计适配桌面和移动端
- 直观的游戏信息显示
- 清晰的玩家状态标识
- 实时游戏日志

### 房主控制功能
- 游戏开始控制
- 整局结束权限（阶段1.5新增）
- 玩家管理功能

## 启动指南

### 环境要求
- Node.js 14+
- npm 6+

### 安装依赖
```bash
npm install
```

### 启动服务器
```bash
npm start
# 或指定端口
PORT=3002 npm start
```

### 访问游戏
打开浏览器访问 `http://localhost:3001` (或指定端口)

## 使用说明

### 基本游戏流程
1. **加入游戏**: 输入玩家名称和买入金额（800-2000筹码）
2. **等待开始**: 等待房主开始游戏（至少需要2名玩家）
3. **游戏进行**: 按照德州扑克规则进行游戏
4. **查看结果**: 摊牌时自动显示获胜者详细信息（阶段1.5）
5. **结束整局**: 房主可选择结束整局查看统计（阶段1.5）

### 玩家动作
- **弃牌 (Fold)**: 放弃当前手牌
- **过牌 (Check)**: 无需下注时选择
- **跟注 (Call)**: 跟上当前最高下注
- **下注 (Bet)**: 首个下注
- **加注 (Raise)**: 在他人下注基础上加注
- **全押 (All-in)**: 押上所有筹码

### 房主功能
- **开始游戏**: 人数满足时开始新一轮
- **结束整局**: 随时结束并查看完整统计（阶段1.5）

## 技术架构

### 设计原则
- **KISS原则**: 保持简单直接
- **YAGNI原则**: 只实现当前需要的功能
- **SOLID原则**: 确保设计合理，职责清晰

### 架构模式
- **聚合根模式**: Game类作为游戏逻辑的统一入口
- **事件驱动**: 通过游戏事件通知状态变化
- **模块化设计**: 清晰的模块分离和职责边界
- **状态管理**: 公共状态和私有状态分离

### 核心组件
- **Game聚合根**: 协调所有游戏模块的主控制器
- **GameState**: 集中的状态存储和管理
- **ActionValidator/ActionApplier**: 动作验证和应用的分离
- **PotManager**: 复杂的多层边池管理
- **HandEvaluator**: 牌力评估和比较

## 扩展性设计

### 易于扩展的功能
- 新增游戏动作类型
- 不同的游戏规则配置
- 更多的游戏事件类型
- 状态持久化支持
- 多桌游戏支持

### 代码组织
- 模块化的文件结构
- 清晰的依赖关系
- 完善的文档系统
- 一致的编码风格

## 开发规范

### 文件管理
- 每个主要模块包含对应的CLAUDE.md文档
- 代码修改后及时更新相关文档
- 保持文档与代码的同步

### 代码风格
- 优先可读性而非简洁性
- 避免"可能用得上"的预设功能
- 确保代码让新人也能理解
- TypeScript警告让步于核心逻辑实现

### 测试策略
- 核心游戏逻辑单元测试
- 端到端集成测试
- 边界情况和异常处理测试

## 问题排查

### 常见问题
1. **连接失败**: 检查服务器是否启动，端口是否被占用
2. **游戏无法开始**: 确保至少有2名玩家且房主已加入
3. **动作无效**: 检查是否轮到该玩家行动，筹码是否足够
4. **页面显示异常**: 刷新页面重新连接

### 调试工具
- 浏览器开发者工具监控WebSocket通信
- 服务端控制台查看游戏事件日志
- 网络面板检查消息传输

## 后续计划

### 潜在扩展功能
- 多桌游戏支持
- 玩家账户系统
- 游戏历史记录
- 更多游戏变体
- 移动端原生应用

### 技术优化
- 状态持久化
- 性能监控
- 负载均衡
- 数据库集成

## 项目成果

阶段1.5成功实现了两个核心功能：
1. **摊牌结果展示**: 提供详细的获胜信息，增强游戏体验
2. **整局结算统计**: 让玩家能够全面了解游戏表现

这些功能的实现体现了系统的扩展性和设计的合理性，为后续功能开发奠定了良好基础。